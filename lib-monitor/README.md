# lib-monitor

`lib-monitor` — это библиотека Lua, предназначенная для мониторинга DVB-тюнеров и потоков каналов в рамках системы Astra. Она предоставляет набор функций для управления и отслеживания состояния различных компонентов мониторинга.

## Основные возможности:

*   **Мониторинг DVB-тюнеров**: Инициализация, запуск, обновление параметров и получение статуса DVB-тюнеров.
*   **Мониторинг каналов**: Создание, обновление, поиск и удаление мониторов для потоков каналов.
*   **Управление адресами мониторинга**: Установка и удаление адресов для отправки данных мониторинга клиентам.
*   **Отправка данных мониторинга**: Функция для отправки собранных данных на настроенные адреса.
*   **Валидация параметров**: Встроенные функции для валидации имен и параметров мониторов.
*   **Получение имени сервера**: Возможность получить имя хоста, на котором запущен монитор.
*   **Гибкая конфигурация**: Поддержка различных типов мониторов (входной, выходной, IP) и настраиваемых параметров, таких как погрешность битрейта, интервалы проверки и методы сравнения.
*   **Интеграция с Astra**: Использует глобальные функции Astra для управления каналами и потоками.
*   **Логирование**: Интегрированное логирование для отслеживания операций и ошибок.

## Структура проекта:

*   `adapters/`: Содержит модули, отвечающие за взаимодействие с различными аппаратными и программными адаптерами. Например, `dvb_tuner.lua` для работы с DVB-тюнерами.
*   `channel/`: Включает модули для управления жизненным циклом каналов и их мониторингом. Например, `channel.lua` для основных операций с каналами и `channel_monitor.lua` для логики мониторинга.
*   `config/`: Хранит файлы конфигурации, определяющие параметры работы мониторов, такие как лимиты и интервалы проверки. Например, `monitor_config.lua` и `monitor_settings.lua`.
*   `dispatcher/`: Содержит менеджеры, которые координируют работу различных типов мониторов, регистрируют их и управляют их состоянием. Например, `channel_monitor_manager.lua` и `dvb_monitor_manager.lua`.
*   `http/`: Модули для создания и управления HTTP-сервером, который может использоваться для взаимодействия с системой мониторинга. Например, `http_server.lua`.
*   `utils/`: Вспомогательные утилиты, такие как модуль логирования (`logger.lua`) и другие общие функции (`utils.lua`).

## Использование:

Библиотека предназначена для использования в проектах, требующих детального мониторинга DVB-тюнеров и потоков каналов. Основные функции включают:

*   `dvb_tuner_monitor(conf)`: Инициализация и запуск мониторинга DVB-тюнера.
*   `make_monitor(config, channel_data)`: Создание и регистрация нового монитора канала.
*   `make_stream(conf)`: Создание и запуск потока с мониторингом.
*   `update_monitor_parameters(name, params)`: Обновление параметров существующего монитора канала.
*   `kill_monitor(monitor_obj)`: Остановка и удаление монитора.
*   `kill_stream(channel_data)`: Остановка потока и связанного с ним монитора.
*   `set_client_monitoring(host, port, path, feed)`: Устанавливает или переопределяет адрес мониторинга для клиентов.
*   `remove_client_monitoring(host, port, path, feed)`: Удаляет конкретный адрес мониторинга для клиента.
*   `get_server_name()`: Возвращает имя хоста сервера.
*   `send_monitor(content, feed)`: Отправляет данные мониторинга на настроенные адреса.
*   `validate_monitor_param(name, value)`: Валидирует параметр монитора на основе его имени, значения и типа/диапазона.
*   `validate_monitor_name(name)`: Валидирует имя монитора.

---
**Примечание**: Для полноценной работы библиотека требует наличия следующих глобальных функций и переменных:
*   **Astra (глобальные функции и переменные, напрямую используемые `lib-monitor`)**:
    *   `astra.version`: Переменная, содержащая версию Astra.
    *   `utils.hostname()`: Функция для получения имени хоста.
    *   `log.info()`, `log.error()`, `log.debug()`: Функции для вывода информационных, ошибочных и отладочных сообщений в лог.
    *   `http_request()`: Функция для выполнения HTTP-запросов.
    *   `find_channel()`: Функция для поиска канала по имени.
    *   `make_channel()`: Функция для создания нового канала.
    *   `kill_channel()`: Функция для остановки и удаления канала.
    *   `get_stream()`: Функция для получения информации о потоке.
    *   `parse_url()`: Функция для парсинга URL-адресов.
    *   `init_input()`: Функция для инициализации входного модуля.
    *   `http_server()`: Функция для запуска HTTP-сервера.
    *   `table.copy()`: Функция для поверхностного копирования таблиц (в `lib-monitor` используется внутренняя реализация, если глобальная недоступна).
    *   `string.split()`: Функция для разделения строки на подстроки (в `cesbo-astra/scripts/base.lua` есть реализация, если глобальная недоступна).
*   **Стандартные Lua функции и переменные (напрямую используемые `lib-monitor`)**:
    *   `type()`: Функция для получения типа переменной.
    *   `tostring()`: Функция для преобразования значения в строку.
    *   `string.format()`: Функция для форматирования строк.
    *   `math.max()`, `math.abs()`: Функции для математических операций.
    *   `ipairs()`, `pairs()`: Функции для итерации по таблицам.
    *   `table.insert()`, `table.remove()`: Функции для работы с таблицами.
    *   `string.match()`: Функция для поиска шаблона в строке.
    *   `string.lower()`: Функция для преобразования строки в нижний регистр.
    *   `pcall()`: Функция для защищенного вызова функции.
